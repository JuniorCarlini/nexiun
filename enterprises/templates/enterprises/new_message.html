{% extends "base/base.html" %}

{% load static %}

{% block title %}Nova Mensagem{% endblock %}

{% block content %}
<div class="container">
    <div class="row align-items-center ms-2 me-3 mb-3 mt-3 justify-content-between">
        <div class="col-auto">
            {% if is_all_units_selected %}
                <h2 class="text-color-primary m-0">Nova Mensagem <span class="fw-light">-> Todas as unidades</span></h2>
            {% elif selected_unit %}
                <h2 class="text-color-primary m-0">Nova Mensagem <span class="fw-light">-> {{ selected_unit.name }}</span></h2>
            {% else %}
                <h2 class="text-color-primary m-0">Nova Mensagem</h2>
            {% endif %}
        </div>
    </div>

    <!-- Formulário de Cadastro -->
    <div class="container-style">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Alerta para seleção de unidade quando necessário -->
            {% if is_all_units_selected and can_add_unit_messages and not can_add_company_messages %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-warning d-flex align-items-center justify-content-around m-0">
                        <i class="fa-solid fa-circle-exclamation me-2 fs-3"></i>
                        <div class="text-center">
                            <strong>Selecione uma unidade específica</strong><br>
                            <small>Para criar mensagens de unidade, você deve selecionar uma unidade específica da empresa.</small>
                        </div>
                        <i class="fa-solid fa-circle-exclamation ms-2 fs-3"></i>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="row">

            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="title" class="form-label fw-bold d-flex align-items-center">Título:</label>
                    <input type="text" 
                            name="title" 
                            id="title" 
                            class="form-control" 
                            value="{{ form_data.title }}"
                            required>
                    <div class="invalid-feedback">
                        Por favor, informe o título da mensagem.
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="level" class="form-label fw-bold d-flex align-items-center">
                        <i class="bi bi-question-circle-fill me-1 small" 
                            style="font-size: 12px;"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="Nível de importância da mensagem"
                            data-bs-custom-class="custom-tooltip">
                        </i>Nível:</label>
                    <select name="level" id="level" class="form-control" required>
                        <option value="info" {% if form_data.level == 'info' %}selected{% endif %}>Info</option>
                        <option value="warning" {% if form_data.level == 'warning' %}selected{% endif %}>Aviso</option>
                        <option value="danger" {% if form_data.level == 'danger' %}selected{% endif %}>Urgente</option>
                    </select>
                    <div class="invalid-feedback">
                        Por favor, selecione um nível.
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="message_destination" class="form-label fw-bold d-flex align-items-center">
                        <i class="bi bi-question-circle-fill me-1 small" 
                            style="font-size: 12px;"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="Destino da mensagem baseado na unidade selecionada na sessão"
                            data-bs-custom-class="custom-tooltip">
                        </i>Destino da Mensagem:</label>
                    
                    {% if is_all_units_selected %}
                        <!-- Quando "Todas as unidades" está selecionado -->
                        {% if can_add_company_messages %}
                            <input type="text" id="message_destination" class="form-control" value="Toda a Empresa" readonly disabled>
                            <input type="hidden" name="scope" value="empresa">
                        {% else %}
                            <input type="text" id="message_destination" class="form-control" value="Todas as unidades - Criação desabilitada" readonly disabled>
                        {% endif %}
                    {% elif selected_unit %}
                        <!-- Unidade específica selecionada na sessão -->
                        <input type="text" id="message_destination" class="form-control" value="{{ selected_unit.name }}" readonly disabled>
                        <input type="hidden" name="scope" value="unidade">
                        <input type="hidden" name="unit_id" value="{{ selected_unit.id }}">
                    {% elif single_unit %}
                        <!-- Usuário tem apenas uma unidade -->
                        <input type="text" id="message_destination" class="form-control" value="{{ single_unit.name }}" readonly disabled>
                        <input type="hidden" name="scope" value="unidade">
                        <input type="hidden" name="unit_id" value="{{ single_unit.id }}">
                    {% elif can_add_company_messages and not can_add_unit_messages %}
                        <!-- Usuário só pode criar mensagens da empresa -->
                        <input type="text" id="message_destination" class="form-control" value="Toda a Empresa" readonly disabled>
                        <input type="hidden" name="scope" value="empresa">
                    {% else %}
                        <!-- Fallback: usuário precisa selecionar -->
                        <input type="text" id="message_destination" class="form-control" value="Nenhuma unidade selecionada na sessão" readonly disabled>
                    {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    <label for="expires_at" class="form-label fw-bold d-flex align-items-center">
                        <i class="bi bi-question-circle-fill me-1 small" 
                            style="font-size: 12px;"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="Data de expiração da mensagem (opcional). Após essa data a mensagem não será mais exibida."
                            data-bs-custom-class="custom-tooltip">
                        </i>Expira em (Opcional):</label>
                    <input type="date" 
                           name="expires_at" 
                           id="expires_at" 
                           class="form-control date-input" 
                           value="{{ form_data.expires_at }}"
                           min="{{ today|date:'Y-m-d' }}">
                    <div class="invalid-feedback">
                        Por favor, selecione uma data de expiração válida.
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <label for="description" class="form-label fw-bold d-flex align-items-center">
                        <i class="bi bi-question-circle-fill me-1 small"
                           style="font-size: 12px;"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           title="Mensagem que será exibida para o usuário."
                           data-bs-custom-class="custom-tooltip">
                        </i>Mensagem:</label>
                    <textarea name="content" 
                              id="content" 
                              class="form-control" 
                              rows="4" 
                              required>{{ form_data.content }}</textarea>
                    <div class="invalid-feedback">
                        Por favor, informe o conteúdo da mensagem.
                    </div>
                </div>
            </div>

            <!-- Botões de ação -->
            <div class="row mt-4">
                <div class="col-12 text-end">
                    <a href="{% url 'list_messages' %}" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left"></i> Voltar
                    </a>
                    <button type="submit" class="btn button-style btn-primary rounded" 
                            style="background-color: {{ enterprise.primary_color }}; border: none;"
                            {% if is_all_units_selected and can_add_unit_messages and not can_add_company_messages %}disabled{% endif %}>
                        <i class="fa-solid fa-check"></i> 
                        {% if is_all_units_selected and can_add_unit_messages and not can_add_company_messages %}
                            Salvar Mensagem (Desabilitado)
                        {% else %}
                            Salvar Mensagem
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validação do formulário
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
    
    // Configurar data de expiração
    const dateInput = document.getElementById('expires_at');
    if (dateInput) {
        // Define data mínima como hoje
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        dateInput.setAttribute('min', todayString);
        
        // Definir data padrão como 7 dias a partir de hoje
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 7);
        const defaultDateString = defaultDate.toISOString().split('T')[0];
        dateInput.value = defaultDateString;
        
        // Validação adicional para data
        dateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to compare only dates
            
            if (selectedDate < today) {
                this.setCustomValidity('A data de expiração deve ser hoje ou uma data futura.');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    // Verificar se "Todas as unidades" está selecionado
    const isAllUnitsSelected = {{ is_all_units_selected|yesno:"true,false" }};
    const canAddUnitMessages = {{ can_add_unit_messages|yesno:"true,false" }};
    const canAddCompanyMessages = {{ can_add_company_messages|yesno:"true,false" }};
    
    // Validação do formulário para bloquear envio quando necessário
    const form = document.querySelector('.needs-validation');
    if (form) {
        form.addEventListener('submit', function(event) {
            // Bloquear envio se "Todas as unidades" está selecionado e usuário só pode criar mensagens de unidade
            if (isAllUnitsSelected && canAddUnitMessages && !canAddCompanyMessages) {
                event.preventDefault();
                event.stopPropagation();
                alert('Para criar mensagens de unidade, você deve selecionar uma unidade específica.');
                return false;
            }
        });
    }
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
})
</script>
{% endblock %}

{% endblock %}